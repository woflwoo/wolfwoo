<script>
(async () => {
  const LIFF_ID  = "2007987243-36ny9WQ7";                 // ← 換成你的
  const API_BASE = "https://wooow.zeabur.app/webhook/school"; // ← 單一 webhook

  const $ = id => document.getElementById(id);
  const show = el => el.style.display = "block";

  // 時間下拉（00~23）
  function buildHourSelect(sel, placeholder){
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = placeholder || "請選擇"; opt0.disabled = true; opt0.selected = true;
    sel.appendChild(opt0);
    for(let h=0; h<24; h++){
      const o = document.createElement("option");
      o.value = String(h).padStart(2,"0");
      o.textContent = String(h).padStart(2,"0");
      sel.appendChild(o);
    }
    sel.style.flex = "1"; sel.style.height = "40px"; sel.style.borderRadius = "10px";
  }

  // 共用
  const qs = (o)=> new URLSearchParams(o).toString();
  const post = (bodyObj)=> fetch(API_BASE, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body: qs(bodyObj),
  });
  const safe = (v, d='—') => (v === undefined || v === null || String(v).trim() === "") ? d : String(v);

  // 預覽列表
  function renderPreview(target, t){
    target.innerHTML = "";
    const rows = [
      ["建立日期", t["建立日期"]],
      ["建立時間", t["建立時間"]],
      ["身分別",   t["身分別"]],
      ["學生姓名", t["學生姓名"]],
      ["學號",     t["學號"]],
      ["問題類別", t["問題類別"]],
      ["問題說明", t["問題說明"]],
      ["聯絡電話", t["聯絡電話"]],
      ["方便聯絡", t["方便聯絡時間"] || t["方便連絡時間"]],
      ["狀態",     t["狀態"]],
    ];
    rows.forEach(([k,v])=>{
      const r = document.createElement("div");
      r.className = "pv-row";
      r.innerHTML = `<div class="pv-k">${k}</div><div class="pv-v">${safe(v)}</div>`;
      target.appendChild(r);
    });
  }

  // ✅ 鎖住結案表單（不可再次編輯／送出）
  function lockResolveForm(label = "已結案"){
    const form = $("resolveForm");
    form.querySelectorAll("input, textarea, select, button").forEach(el => {
      if (el.tagName === "BUTTON") {
        el.disabled = true;
        el.textContent = label;
        el.style.opacity = "0.7";
        el.style.cursor = "not-allowed";
      } else {
        el.readOnly = true;
        el.disabled = true;
      }
    });
    $("subtitle").textContent = "此工單已結案，無法再次提交。";
  }

  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    const u = new URL(location.href);
    const action   = u.searchParams.get("action") || "ticket";
    const ticketId = u.searchParams.get("ticketId") || "";
    const token    = u.searchParams.get("token") || "";

    const profile = await liff.getProfile().catch(()=>null);
    const context = liff.getContext?.() || {};
    const userId = profile?.userId || context.userId || "";
    const displayName = profile?.displayName || "";

    if (action === "ticket") {
      $("title").textContent = "問題工單";
      $("subtitle").textContent = "請填寫以下資訊，我們將盡快與您聯絡。";
      show($("ticketForm"));

      // 時間選單
      const hourStart = document.querySelector('select[name="hour_start"]');
      const hourEnd   = document.querySelector('select[name="hour_end"]');
      buildHourSelect(hourStart, "開始");
      buildHourSelect(hourEnd,   "結束");

      $("ticketForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const btn = $("submitBtn");
        btn.disabled = true; $("msg").className = "msg"; $("msg").innerText = "送出中…";

        const fd = new FormData(e.currentTarget);
        const payload = Object.fromEntries(fd);

        // contact_time：HH:00-HH:00
        const hs = payload.hour_start, he = payload.hour_end;
        if (hs && he) {
          if (Number(he) <= Number(hs)) {
            $("msg").className = "msg err";
            $("msg").innerText = "結束時間需晚於開始時間。";
            btn.disabled = false; return;
          }
          payload.contact_time = `${hs}:00-${he}:00`;
        }
        delete payload.hour_start; delete payload.hour_end;

        payload.is_student = (payload.identity === "在校生");
        payload.user_id = userId;
        payload.user_name = displayName;
        payload.kind = "ticket"; // 分流關鍵

        try {
          const r = await post(payload);
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const j = await r.json().catch(()=>({}));
          $("msg").className = "msg ok";
          $("msg").innerText = j.message || "已送出，謝謝！";
          // 送出後不關視窗就把按鈕鎖住，避免重送
          btn.textContent = "已送出";
          btn.disabled = true;
          btn.style.opacity = "0.7";
        } catch (err) {
          $("msg").className = "msg err";
          $("msg").innerText = "送出失敗：" + (err?.message || err);
          btn.disabled = false;
        }
      });

    } else if (action === "resolve") {
      $("title").textContent = "查看／處理工單";
      $("subtitle").textContent = "請確認工單內容，並輸入處理人姓名完成結案。";
      show($("resolveForm"));
      $("tid").value = ticketId;
      document.querySelector('input[name="handler_name"]').value = displayName || "";

      // ① 取「工單預覽」
      let serverStatus = "OPEN";
      try {
        const r1 = await post({
          kind: "resolve",       // Router 會導到 liff_resolve
          op: "preview",         // 後端判定：查詢
          ticket_id: ticketId,
          user_id: userId
        });
        const j1 = await r1.json().catch(()=> ({}));
        const t = j1.ticket || j1.row || j1.data || j1 || {};
        serverStatus = String(t["狀態"] || "").toUpperCase() || "OPEN";
        renderPreview($("previewBox"), t);

        // ✅ 若非 OPEN（例如 CLOSED），一進頁就鎖住
        if (serverStatus !== "OPEN") {
          lockResolveForm("已結案");
        }
      } catch (err) {
        $("resolveMsg").className = "msg err";
        $("resolveMsg").innerText = "讀取工單內容失敗（仍可直接結案）。";
      }

      // ② 送出結案
      $("resolveForm").addEventListener("submit", async (e)=>{
        e.preventDefault();

        if (serverStatus !== "OPEN") {
          $("resolveMsg").className = "msg err";
          $("resolveMsg").innerText = "此工單已結案，無法再次提交。";
          lockResolveForm("已結案");
          return;
        }

        const payload = Object.fromEntries(new FormData(e.currentTarget));
        payload.ticket_id = ticketId;
        payload.token = token;
        payload.handler_user_id = userId;
        payload.kind = "resolve";
        payload.op = "commit";     // 後端據此執行「更新」

        if (!confirm(`確認將工單 ${ticketId} 標記為已處理？\n處理人：${payload.handler_name || displayName || "-"}`)) {
          return;
        }

        const btn = $("resolveBtn");
        btn.disabled = true; $("resolveMsg").className = "msg"; $("resolveMsg").innerText = "送出中…";

        try {
          const r2 = await post(payload);
          if (!r2.ok) throw new Error(`HTTP ${r2.status}`);
          const j2 = await r2.json().catch(()=>({}));
          $("resolveMsg").className = "msg ok";
          $("resolveMsg").innerText = j2.message || "已結案，感謝！";

          // ✅ 成功後立即鎖住，避免再次送出
          serverStatus = "CLOSED";
          lockResolveForm("已結案");
        } catch (err) {
          $("resolveMsg").className = "msg err";
          $("resolveMsg").innerText = "送出失敗：" + (err?.message || err);
          btn.disabled = false;
        }
      });
    }
  } catch (err) {
    const m = document.createElement("div");
    m.className = "msg err";
    m.innerText = "LIFF 初始化失敗：" + (err?.message || err);
    document.querySelector(".card").appendChild(m);
  }
})();
</script>
